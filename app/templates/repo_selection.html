{% from "macros.html" import load_async with context %}

<!-- NOTE: only show inputes for repos that are configured for making connections. Grey out the once that the user has not yet connected to. -->
<div class="form-group mt-3 mb-3">
    <h2>Repository</h2>
    {% for service in registered_services %}
    {% if service not in data.temp_hidden_services %}
    {% if service != 'owncloud' %}
    {% if ('showall' in data and data.showall) or (service not in data.hidden_services)%}
    {% set imgfilepath = '/img/'+service+'.png' %}
    {% set access_token_name = service +'_access_token' %}
    <div class="form-check form-check-inline mt-3 mb-3 col-3">
        <input class="form-check-input" type="radio" name="selected_repo" id="radio-{{service}}" value="{{service}}"
            {% if service == data.repo %} checked {% endif %}
            {% if access_token_name not in data and service!="datahugger" %}disabled{% endif %} required >
        <label for="radio-{{service}}"><img src="{{ url_for('static', filename = imgfilepath) }}"
                alt="{{service}}" {% if access_token_name not in data and service!="datahugger" %}style="-webkit-filter: grayscale(100%); filter: grayscale(100%); opacity: 0.4;"{% endif %}></label>
        {% set service_description = service+'_description' %}
        {% set service_website = service+'_website' %}
        
        {% if service == 'datahugger' %}
        <p><small>{{ repo_selection_datahugger_import | default("Import open data with Datahugger") | safe }}</small></p>
        {% else %}
        <p><small>{{ all_vars[service_description] }}</small></p>
        {% endif %}
        
        {% if access_token_name not in data %}
        
        
        
            {% if service == 'datahugger' %}
            <p><small>{{ repo_selection_uses_datahugger | default("Uses the <a href='https://j535d165.github.io/datahugger/' target='_blank'>Datahugger project</a>") | safe }}</small></p>
            {% else %}
                {% if service == 'data4tu' %}
                <p><small>{{ repo_selection_go_to | default("Go to <a href='/connect'>your connections</a> to connect to") | safe }} 4TU.ResearchData</small></p>
                {% else %}
                <p><small>{{ repo_selection_go_to | default("Go to <a href='/connect'>your connections</a> to connect to") | safe }} {{ service }}</small></p>
                {% endif %}
            {% endif %}
        {% endif %}
    </div>
    {% endif %}
    {% endif %}
    {% endif %}
    {% endfor %}
    <div class="form-check form-check-inline mt-3 mb-3 col-3">
        <input class="form-check-input" type="radio" name="selected_repo" id="radio-none" value="none" required hidden>
        <div class="invalid-feedback">
            {{ repo_selection_select_repo | default("Please select a repository!") | safe }}
        </div>
    </div>
</div>

<script>
    // This will load the correct metadata fields when the user changes the repo.
$('input[type=radio][name=selected_repo]').change(function() {
    if (this.value == 'figshare') {
        $("#action-button").prop('disabled', false);
        $("#show_meta").html('<div id="show_meta" class="spinner-border text-secondary" role="status">');
        $("#show_meta").load("/metadata?repo=figshare");
        $("#show_dataverses").empty();
    }
    else if (this.value == 'data4tu') {
        $("#action-button").prop('disabled', false);
        $("#show_meta").html('<div id="show_meta" class="spinner-border text-secondary" role="status">');
        $("#show_meta").load("/metadata?repo=data4tu");
        $("#show_dataverses").empty();
    }
    else if (this.value == 'zenodo') {
        $("#action-button").prop('disabled', false);
        $("#show_meta").html('<div id="show_meta" class="spinner-border text-secondary" role="status">');
        $("#show_meta").load("/metadata?repo=zenodo");
        $("#show_dataverses").empty();
    }
    else if (this.value == 'osf') {
        $("#action-button").prop('disabled', false);
        $("#show_meta").html('<div id="show_meta" class="spinner-border text-secondary" role="status">');
        $("#show_meta").load("/metadata?repo=osf");
        $("#show_dataverses").empty();
    }
    else if (this.value == 'dataverse') {
        $("#action-button").prop('disabled', false);
        $("#show_dataverses").html('<div id="show_dataverses"><div class="spinner-border text-secondary" role="status"></div>... loading dataverses</div>')
        $("#show_dataverses").load("/dataverses");
        $("#show_meta").html('<div id="show_meta" class="spinner-border text-secondary" role="status"></div>... loading metadatafields from dataverse</div>');
        $("#show_meta").load("/metadata?repo=dataverse");
    }
    else if (this.value == 'datastation') {
        $("#action-button").prop('disabled', false);
        $("#show_meta").html('<div id="show_meta" class="spinner-border text-secondary" role="status"></div>... loading metadatafields from datastation</div>');
        $("#show_meta").load("/metadata?repo=datastation");
        $("#show_dataverses").html('<div id="show_dataverses"><div class="spinner-border text-secondary" role="status"></div>... loading dataverses</div>')
        $("#show_dataverses").load("/dataverses?datastation=true"); 
    }
    else if (this.value == 'irods') {
        $("#action-button").prop('disabled', false);
        $("#show_meta").html('<div id="show_meta" class="spinner-border text-secondary" role="status">');
        $("#show_meta").load("/metadata?repo=irods");
        $("#show_dataverses").empty();
    }
    else if (this.value == 'sharekit') {
        $("#action-button").prop('disabled', false);
        $("#show_meta").html('<div id="show_meta" class="spinner-border text-secondary" role="status">');
        $("#show_meta").load("/metadata?repo=sharekit");
        $("#show_dataverses").empty();
    }
    else if (this.value == 'surfs3') {
        $("#action-button").prop('disabled', false);
        $("#show_meta").html('<div id="show_meta" class="spinner-border text-secondary" role="status">');
        $("#show_meta").load("/metadata?repo=surfs3");
        $("#show_dataverses").empty();
    }

});
</script>
{% for service in registered_services %}
    {% if service == data.repo %}
    <script>
        $("#action-button").prop('disabled', false);
        $('input[type=radio][name=selected_repo][value={{service}}]').attr('checked',true);
        $("#show_meta").html('<div id="show_meta" class="spinner-border text-secondary" role="status"></div>... loading metadatafields</div>');
        $("#show_meta").load("/metadata?repo={{service}}");
    </script>
    {% endif %}
{% endfor %}

{% if data.repo == 'dataverse' %}
<script>
    $("#action-button").prop('disabled', false);
    $("#show_dataverses").html('<div id="show_dataverses"><div class="spinner-border text-secondary" role="status"></div>... loading dataverses</div>')
    $("#show_dataverses").load("/dataverses"); 
</script>
{% endif %}

{% if data.repo == 'datastation' %}
<script>
    $("#action-button").prop('disabled', false);
    $("#show_dataverses").html('<div id="show_dataverses"><div class="spinner-border text-secondary" role="status"></div>... loading dataverses</div>')
    $("#show_dataverses").load("/dataverses?datastation=true"); 
</script>
{% endif %}
